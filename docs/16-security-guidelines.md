# 16-security-guidelines.md  
## Руководство по безопасности Reputa 2.0

Документ описывает политики безопасности, архитектурные принципы, правила работы с данными клиник, AI-трафиком, API, Supabase и n8n.  
Reputa — продукт, который взаимодействует с чувствительной информацией, поэтому безопасность является обязательной частью архитектуры.

---

# 1. Общие принципы безопасности

1. **Zero-Trust Architecture**  
   Каждый компонент должен проверять входящие данные — никаких implicit trust-каналов.

2. **Минимизация поверхностей атаки**  
   Только необходимые API-эндпоинты. Никаких «общих» маршрутов или открытых ресурсов.

3. **Изоляция ключей и секретов**  
   - AI-ключи хранятся **только на серверной стороне n8n**.  
   - Фронтенд получает только прокси-эндпоинты `/api/...` → никакого прямого доступа.

4. **Шифрование данных в покое и при передаче**  
   - TLS обязателен.  
   - Данные в Supabase зашифрованы.  

5. **Принцип минимально необходимых прав**  
   - RLS в Supabase строго включён.  
   - API-запросы получают только те данные, которые нужны UI.

---

# 2. Безопасность Supabase

Supabase — основная база данных Reputa.  
Обязательные политики:

## 2.1. Row Level Security (RLS)
- Включён всегда.  
- Запросы читают только свои записи (для мульти-клиник — через `business_id`).  
- Анонимные запросы ограничены (frontend → только публичные селекты).

## 2.2. Policies (рекомендованные)
- `select` — только конкретные таблицы, только с фильтрацией.  
- `insert` — разрешено только из n8n через сервисный ключ.  
- `update` — только n8n или аутентифицированный пользователь (фаза 2).  
- `delete` — запрещён для всех кроме сервера.

## 2.3. Edge Functions
Для более опасных операций (например: возврат PDF, агрегации) используется Edge Function.

---

# 3. Безопасность n8n

n8n выполняет 95% серверных операций → он должен быть максимально защищён.

## 3.1. Доступ
- доступ только по IP whitelist  
- отдельный домен вида `workflow.reputa.ai`  
- использование Basic Auth как минимум  
- для продакшена предпочтителен JWT

## 3.2. API-ключи
- хранятся как **Environment Variables**  
- доступ имеют только нужные workflows  
- ключи AI не могут быть вызваны фронтом напрямую

## 3.3. Webhooks
- каждый webhook имеет секрет  
- запросы валидируются:  
  - домен  
  - метод  
  - origin  
  - сигнатура (если включён HMAC)

## 3.4. Логи
- все ошибки → в таблицу `logs`  
- критические ошибки → в Telegram  
- логируются только необходимые данные (GDPR-like принцип минимизации)

---

# 4. Безопасность фронтенда (Next.js)

## 4.1. Прокси вместо прямых запросов
Фронт **никогда не обращается** напрямую к n8n или AI.  
Всегда через:

